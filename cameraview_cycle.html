<!doctype html>
<!--
   ___                                       _
  / __\__ _ _ __ ___   ___ _ __ __ _  /\   /(_) _____      __
 / /  / _` | '_ ` _ \ / _ \ '__/ _` | \ \ / / |/ _ \ \ /\ / /
/ /__| (_| | | | | | |  __/ | | (_| |  \ V /| |  __/\ V  V /
\____/\__,_|_| |_| |_|\___|_|  \__,_|   \_/ |_|\___| \_/\_/


Auto-cycle videos from a predefined list (config.json).
If the config.json file changes the page will reload to grab the new videos.
-->

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Embedded Video</title>
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <style>
      html,
      body {
        margin: 0;
        height: 100%;
        background: #000;
      }
      iframe {
        position: fixed;
        inset: 0;
        width: 100vw;
        height: 100vh;
        border: 0;
      }
    </style>
  </head>
  <body>
    <iframe
      id="vidFrame"
      title="Video"
      allow="autoplay; fullscreen; picture-in-picture; encrypted-media"
      allowfullscreen
      referrerpolicy="strict-origin-when-cross-origin"
    >
    </iframe>
    <script>
      const configLocation =
        "https://willavos.github.io/camera-view/config.json";

      async function getConfigHash() {
        const configText = await fetch(configLocation, {
          cache: "no-store",
        }).then((r) => r.text());
        const hashBuffer = await crypto.subtle.digest(
          "SHA-256",
          new TextEncoder().encode(configText),
        );
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map((b) => b.toString(16).padStart(2, "0")).join("");
      }

      function shuffle(array) {
        let currentIndex = array.length;
        while (currentIndex != 0) {
          let randomIndex = Math.floor(Math.random() * currentIndex);
          currentIndex--;
          [array[currentIndex], array[randomIndex]] = [
            array[randomIndex],
            array[currentIndex],
          ];
        }
      }

      async function main() {
        const config = await fetch(configLocation).then((r) => r.json());
        const initialConfigHash = await getConfigHash();
        shuffle(config.videos);

        // Config has the video name, code and duration to be played.
        // Loop through the array of videos and play them one after the other waiting for each to finish.
        while (true) {
          for (const video of config.videos) {
            const name = video.name;
            const code = video.youtube_id;
            const duration = video.run_time; // Duration in minutes

            const base = "https://www.youtube-nocookie.com/embed/";
            const query = `?autoplay=1&mute=1&controls=0&rel=0&modestbranding=1&playsinline=1&vq=hd1080`;
            const vidSrc = base + code + query;
            document.getElementById("vidFrame").src = vidSrc;

            console.log("Set src to", vidSrc);
            await new Promise((resolve) =>
              setTimeout(resolve, duration * 60 * 1000),
            );

            const newConfigHash = await getConfigHash();
            if (newConfigHash !== initialConfigHash) {
              console.log("Config hash has changed, reloading page...");
              location.reload(); // Refresh the page
            }
          }
        }
      }

      main();
    </script>
  </body>
</html>
